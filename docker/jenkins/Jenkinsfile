
node('master') {
    checkout scm
    def test = new File("${WORKSPACE}/docker/jenkins/env/test").readLines()
    def hostinfo = new File("${WORKSPACE}/docker/jenkins/hostinfo").readLines()
    withEnv(test + hostinfo) {
        stage('test build') {
          sh 'grep FROM Dockerfile | awk \'{print $2}\' | xargs docker pull'
          sh '''docker-compose -p ${ENVIRONMENT} build && \
                docker-compose -p ${ENVIRONMENT} down -v && \
                docker-compose -p ${ENVIRONMENT} up -d'''
          sh 'sleep 30'
          sh 'helpers/check_status_code https://${ENVIRONMENT}.${DOMAIN}/login'
          sh 'docker-compose -p ${ENVIRONMENT} down -v'
        }
    }
}
node('vagrant') {
    def prod = new File("${WORKSPACE}/docker/jenkins/env/prod").readLines()
    def hostinfo = new File("${WORKSPACE}/docker/jenkins/hostinfo").readLines()
    withEnv(prod + hostinfo) {
        checkout scm
        stage('copy artifacts') {
          copyArtifacts('cidr')
        }
        stage('restart Jenkins') {
          sh '''docker-compose -p ${ENVIRONMENT} build && \
                docker-compose -p ${ENVIRONMENT} down && \
                docker-compose -p ${ENVIRONMENT} up -d'''
        }
    }
}
